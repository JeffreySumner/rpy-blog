---
title: "Visualizations with R and Python"
description: "Visualizing the R for Excel workshop with both R and Python"
author:
  - name: Jeffrey Sumner
date: 2023-05-08
categories: [R, Python, Visualization]
format: html
editor: visual
---

```{r}
#| include: false
#| warning: false
#| message: false
library(reticulate)

# Resolve post root whether rendering from repo root or post folder
post_candidates <- c(".", "posts/r-python-visualizations")
post_root <- post_candidates[file.exists(file.path(post_candidates, "pyproject.toml"))][1]

if (is.na(post_root) || !nzchar(post_root)) {
  stop("Could not resolve post root for r-python-visualizations.")
}

# Activate renv from this post, then restore/install only if key packages are missing
activate_path <- file.path(post_root, "renv", "activate.R")
if (!file.exists(activate_path)) {
  stop("Missing renv/activate.R in post directory.")
}
source(activate_path, local = TRUE)

required_r_pkgs <- c("readr", "readxl", "ggplot2", "reticulate")
missing_r_pkgs <- required_r_pkgs[!vapply(required_r_pkgs, requireNamespace, quietly = TRUE, FUN.VALUE = logical(1))]
if (length(missing_r_pkgs) > 0) {
  message("Missing R packages detected: ", paste(missing_r_pkgs, collapse = ", "))
  message("Running renv::restore() for this post...")
  renv::restore(project = post_root, prompt = FALSE)

  # Fallback: install any package still missing after restore
  still_missing <- required_r_pkgs[!vapply(required_r_pkgs, requireNamespace, quietly = TRUE, FUN.VALUE = logical(1))]
  if (length(still_missing) > 0) {
    message("Installing still-missing R packages: ", paste(still_missing, collapse = ", "))
    install.packages(still_missing, repos = "https://packagemanager.posit.co/cran/latest")
  }
}

# Ensure post-local uv venv exists; create it automatically if uv is available
python_path <- file.path(post_root, ".venv", "Scripts", "python.exe")
if (!file.exists(python_path)) {
  uv_bin <- Sys.which("uv")
  if (!nzchar(uv_bin)) {
    stop(
      "Missing post-local Python venv and uv not found. ",
      "Install uv, then run: uv sync --project posts/r-python-visualizations"
    )
  }
  message("Post venv missing, running uv sync...")
  system2(uv_bin, c("sync", "--project", post_root))
}

if (!file.exists(python_path)) {
  stop("Python venv setup failed. Expected: ", python_path)
}

use_python(python_path, required = TRUE)
message("Using Python: ", normalizePath(python_path, winslash = "/", mustWork = FALSE))

# Make relative paths consistent for the rest of the document
setwd(post_root)
```

## Reading data into R/Python

Below are the ways that we will be reading in our data from this post's local `data/` directory with both R and python. For R users, we will use the `readr::` and `readxl::` packages while python users will read data with `pandas`. Let's view the examples below.

::: panel-tabset
### R

For R we will need to initialize a few packages.

```{r}
#| message: false
#| warning: false
library(readr)
library(readxl)

ca_np <- readr::read_csv("data/ca_np.csv")
ci_np <- readxl::read_xlsx("data/ci_np.xlsx")

str(ca_np)
```

### Python

For python we will need to import pandas and Path from pathlib. Path will behave similarly to the here function that the R book uses.

```{python}
import pandas as pd
from pathlib import Path

ca_np_path = Path("data/ca_np.csv")
ci_np_path = Path("data/ci_np.xlsx")

ca_np = pd.read_csv(ca_np_path)
ci_np = pd.read_excel(ci_np_path, engine='openpyxl')

ca_np.info()
```
:::

## Creating visuals: Visitors to Channel Islands NP

Below we will create our first basic visual using both R and python. With the R code we will only use `ggplot2` to create this visual. For python, we will use `plotnine` which uses R's `ggplot2` syntax.

::: panel-tabset
### R (ggplot2)

For R we will need to initialize a few packages.

```{r}

ggplot2::ggplot(data = ci_np, ggplot2::aes(x = year, y = visitors)) +
  ggplot2::geom_line()
```

### Python (plotnine)

```{python}
import matplotlib.pyplot as plt
from plotnine import ggplot, aes, geom_line
plt.switch_backend('agg')

# Creating the plot
plot = (
    ggplot(data=ci_np, mapping=aes(x='year', y='visitors'))
    + geom_line()
)

# Displaying the plot
print(plot)
```
:::

Now that we have a few basic plots created across each package/library, let's create a base plot object and create variations off of it. This will be done similar to the R for Excel

::: panel-tabset
### R (ggplot2)

```{r}

gg_base_r <- ggplot2::ggplot(data = ci_np, ggplot2::aes(x = year, y = visitors))

gg_base_r +
  ggplot2::geom_point()

```

### Python (plotnine)

```{python}
from plotnine import ggplot, aes, geom_point
gg_base_py = ggplot(data=ci_np, mapping=aes(x='year', y='visitors'))
gg_base_py + geom_point()

```
:::

You can find the public source repository for this and other posts at [JeffreySumner/rpy-blog](https://github.com/JeffreySumner/rpy-blog).
